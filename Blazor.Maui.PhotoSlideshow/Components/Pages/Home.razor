@page "/"
@using PhotoSlideshow.Services
@using PhotoSlideshow.Models
@inject SlideshowService SlideshowService
@inject ImageCacheService ImageCacheService
@inject ImageConverterService ImageConverter
@implements IDisposable

<div class="slideshow-container">
    @if (_currentImages.Any())
    {
        <div class="mosaic-grid">
            @foreach (var image in _currentImages)
            {
                @if (!string.IsNullOrEmpty(image.CachedPath))
                {
                    <div class="image-item @(image.IsFullScreen ? "fullscreen" : "")"
                         style="@(image.IsFullScreen ? $"transform: rotate({image.Rotation}deg) scale({image.Scale}); opacity: {image.Opacity}; z-index: 1000;" : $"opacity: {image.Opacity};")">
                        <img src="@ImageConverter.ConvertToBase64(image.CachedPath)" alt="Photo" />
                    </div>
                }
            }
        </div>
    }
    else
    {
        <div class="loading">
            <p>Scan du réseau en cours...</p>
            <p>L'affichage démarrera dès les premières images trouvées</p>
        </div>
    }
</div>

<div class="controls">
    <button @onclick="ToggleAnimation">@(_isRunning ? "Pause" : "Démarrer")</button>
    <button @onclick="ClearCacheAndReload">Vider le cache</button>
    <button @onclick="ToggleSettings">⚙️ Paramètres</button>
    <div class="status">
        @if (!SlideshowService.IsLoadingComplete)
        {
            <p>Chargement: @SlideshowService.LoadedImages / @SlideshowService.TotalImages</p>
            @if (SlideshowService.TotalImages > 0)
            {
                <progress value="@SlideshowService.LoadedImages" max="@SlideshowService.TotalImages"></progress>
            }
        }
        else
        {
            <p>✓ @SlideshowService.TotalImages images chargées</p>
        }
    </div>
</div>

@if (_showSettings)
{
    <div class="settings-panel">
        <h3>Configuration</h3>
        <div class="form-group">
            <label for="networkFolder">Chemin réseau des photos:</label>
            <input type="text" id="networkFolder" @bind="_networkFolderInput" placeholder="\\SERVEUR\dossier\photos" />
        </div>
        <div class="settings-buttons">
            <button @onclick="SaveSettings" class="btn-primary">Enregistrer</button>
            <button @onclick="ToggleSettings" class="btn-secondary">Annuler</button>
        </div>
    </div>
}

@code {
    private bool _isRunning = false;
    private bool _showSettings = false;
    private string _networkFolderInput = string.Empty;
    private List<ImageItem> _currentImages = new();

    protected override async Task OnInitializedAsync()
    {
        _networkFolderInput = ImageCacheService.NetworkFolder;
        
        SlideshowService.OnImagesChanged += OnImagesChanged;
        SlideshowService.OnFullScreenChanged += OnFullScreenChanged;

        await SlideshowService.InitializeAsync();
        UpdateImageSnapshot();
    }

    private void OnImagesChanged()
    {
        InvokeAsync(() =>
        {
            UpdateImageSnapshot();
            StateHasChanged();
        });
    }

    private void OnFullScreenChanged(int index)
    {
        InvokeAsync(() =>
        {
            UpdateImageSnapshot();
            StateHasChanged();
        });
    }

    private void UpdateImageSnapshot()
    {
        _currentImages = SlideshowService.Images.ToList();
    }

    private void ToggleAnimation()
    {
        if (_isRunning)
        {
            SlideshowService.StopAnimation();
        }
        else
        {
            SlideshowService.StartAnimation();
        }
        _isRunning = !_isRunning;
    }

    private void ToggleSettings()
    {
        _showSettings = !_showSettings;
        if (_showSettings)
        {
            _networkFolderInput = ImageCacheService.NetworkFolder;
        }
    }

    private async Task SaveSettings()
    {
        if (!string.IsNullOrWhiteSpace(_networkFolderInput))
        {
            ImageCacheService.NetworkFolder = _networkFolderInput;
            _showSettings = false;
            await ClearCacheAndReload();
        }
    }

    private async Task ClearCacheAndReload()
    {
        SlideshowService.StopAnimation();
        _isRunning = false;
        ImageConverter.ClearCache();

        await SlideshowService.InitializeAsync();
        UpdateImageSnapshot();
        StateHasChanged();
    }

    public void Dispose()
    {
        SlideshowService.OnImagesChanged -= OnImagesChanged;
        SlideshowService.OnFullScreenChanged -= OnFullScreenChanged;
        SlideshowService.StopAnimation();
    }
}